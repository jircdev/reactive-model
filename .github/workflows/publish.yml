name: Publish to NPM

on:
    push:
        branches:
            - deploy/npm

jobs:
    build-and-publish:
        runs-on: ubuntu-latest
        permissions:
            id-token: write  # Required for OIDC/Trusted Publishing
            contents: read   # Required for checkout

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  registry-url: 'https://registry.npmjs.org'

            - name: Update npm to latest version
              run: npm install -g npm@latest

            - name: Install dependencies
              working-directory: src
              run: |
                if [ -f package-lock.json ]; then
                  npm ci
                else
                  npm install
                fi

            - name: Build package
              working-directory: src
              run: npm run build

            # Trusted Publishing: Uses OIDC authentication automatically
            # No NODE_AUTH_TOKEN needed - npm detects GitHub Actions OIDC environment
            # Ensure the workflow filename matches your Trusted Publisher config on npmjs.com
            # Note: For first-time publishing, you may need to publish manually once
            - name: Verify npm configuration
              working-directory: src
              run: |
                echo "npm version: $(npm --version)"
                echo "Node version: $(node --version)"
                echo "Package name: $(node -p "require('./package.json').name")"
                echo "Package version: $(node -p "require('./package.json').version")"
                echo "Registry: $(npm config get registry)"
                # Verify OIDC environment variables are available
                if [ -n "$ACTIONS_ID_TOKEN_REQUEST_URL" ]; then
                  echo "✓ OIDC environment detected"
                else
                  echo "✗ OIDC environment not detected"
                fi
            
            - name: Publish to NPM
              working-directory: src
              run: npm publish --access public --provenance
